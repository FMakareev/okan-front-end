b3aaa4f6493124a1c77bbafab0851cc5
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.userRemove = exports.userUpdate = exports.userInit = void 0;

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _actionTypes = require("./actionTypes");

var _index = require("../../../apollo/index.client");

var _index2 = require("../../../apollo/index.server");

var _CurrentUserItemQuery = _interopRequireDefault(require("./CurrentUserItemQuery.graphql"));

var _resetUserToken = require("./resetUserToken");

/* global isBrowser */

/**
 * @desc метод инициализации пользователя в системе
 * */
var userInit = function userInit(state, request) {
  return function (dispatch) {
    var client = null;

    if (isBrowser) {
      client = (0, _index.client)();
    } else {
      client = (0, _index2.client)(request);
    }

    return new Promise(function (resolve, reject) {
      try {
        if (!state.user.initLoading && !state.user.isAuth) {
          dispatch({
            type: _actionTypes.USER_INIT_LOADING_START
          });
          client.query({
            query: _CurrentUserItemQuery["default"]
          }).then(function (response) {
            console.log('response:', response);
            var data = response.data;

            if (isBrowser) {
              localStorage.setItem('user', JSON.stringify(data.currentuseritem));
            }

            dispatch({
              type: _actionTypes.USER_INIT_LOADING_SUCCESS,
              user: (0, _objectSpread2["default"])({}, data.currentuseritem)
            });
            resolve(data.currentuseritem);
          })["catch"](function (error) {
            if (isBrowser) {
              localStorage.clear();
            }

            console.error('Error userInit: ', error);
            /** */

            dispatch({
              type: _actionTypes.USER_INIT_LOADING_ERROR,
              user: {
                error: _actionTypes.USER_NOT_AUTHORIZED
              }
            });
            resolve(error);
          });
        } else {
          resolve(true);
        }
      } catch (error) {
        console.error('Error userInit: ', error);
        dispatch({
          type: _actionTypes.USER_INIT_LOADING_ERROR,
          user: {
            error: _actionTypes.USER_NOT_AUTHORIZED
          }
        });
        resolve(error);
      }
    });
  };
};

exports.userInit = userInit;

var userUpdate = function userUpdate() {
  return function (dispatch) {
    var client = null;

    if (isBrowser) {
      client = _index.client;
    } else {
      client = _index2.client;
    }

    return new Promise(function (resolve, reject) {
      try {
        dispatch({
          type: _actionTypes.USER_UPDATE_LOADING_START,
          user: {
            loading: true
          }
        });
        client().query({
          query: _CurrentUserItemQuery["default"]
        }).then(function (response) {
          var data = response.data;

          if (isBrowser) {
            localStorage.setItem('user', JSON.stringify(data.currentuseritem));
          }

          dispatch({
            type: _actionTypes.USER_UPDATE_LOADING_SUCCESS,
            user: (0, _objectSpread2["default"])({}, data.currentuseritem)
          });
          resolve(data.currentuseritem);
        })["catch"](function (error) {
          console.log(error);

          if (isBrowser) {
            localStorage.clear();
          }

          dispatch({
            type: _actionTypes.USER_UPDATE_LOADING_ERROR,
            user: {
              error: error
            }
          });
          reject(error);
        });
      } catch (error) {
        reject(error);
      }
    });
  };
};

exports.userUpdate = userUpdate;

var userRemove = function userRemove() {
  return function (dispatch) {
    return new Promise(function (resolve, reject) {
      try {
        if (isBrowser) {
          // window.localStorage.clear();
          // const cookies = document.cookie.split(';');
          // for (let i = 0; i < cookies.length; i += 1) {
          //   const cookie = cookies[i];
          //   const eqPos = cookie.indexOf('=');
          //   const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
          //   document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT`;
          // }
          (0, _resetUserToken.resetUserToken)();
          dispatch(_actionTypes.USER_REMOVE);
          resolve(true);
        }
      } catch (error) {
        reject(error);
      }
    });
  };
};

exports.userRemove = userRemove;
var _default = {
  userInit: userInit,
  userUpdate: userUpdate,
  userRemove: userRemove
};
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFjdGlvbnMuanMiXSwibmFtZXMiOlsidXNlckluaXQiLCJzdGF0ZSIsInJlcXVlc3QiLCJkaXNwYXRjaCIsImNsaWVudCIsImlzQnJvd3NlciIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0IiwidXNlciIsImluaXRMb2FkaW5nIiwiaXNBdXRoIiwidHlwZSIsIlVTRVJfSU5JVF9MT0FESU5HX1NUQVJUIiwicXVlcnkiLCJDdXJyZW50VXNlckl0ZW1RdWVyeSIsInRoZW4iLCJyZXNwb25zZSIsImNvbnNvbGUiLCJsb2ciLCJkYXRhIiwibG9jYWxTdG9yYWdlIiwic2V0SXRlbSIsIkpTT04iLCJzdHJpbmdpZnkiLCJjdXJyZW50dXNlcml0ZW0iLCJVU0VSX0lOSVRfTE9BRElOR19TVUNDRVNTIiwiZXJyb3IiLCJjbGVhciIsIlVTRVJfSU5JVF9MT0FESU5HX0VSUk9SIiwiVVNFUl9OT1RfQVVUSE9SSVpFRCIsInVzZXJVcGRhdGUiLCJicm93c2VyQ2xpZW50Iiwic2VydmVyQ2xpZW50IiwiVVNFUl9VUERBVEVfTE9BRElOR19TVEFSVCIsImxvYWRpbmciLCJVU0VSX1VQREFURV9MT0FESU5HX1NVQ0NFU1MiLCJVU0VSX1VQREFURV9MT0FESU5HX0VSUk9SIiwidXNlclJlbW92ZSIsIlVTRVJfUkVNT1ZFIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUVBOztBQVVBOztBQUNBOztBQUNBOztBQUNBOztBQWZBOztBQWlCQTs7O0FBR08sSUFBTUEsUUFBUSxHQUFHLFNBQVhBLFFBQVcsQ0FBQ0MsS0FBRCxFQUFRQyxPQUFSO0FBQUEsU0FBb0IsVUFBQUMsUUFBUSxFQUFJO0FBQ3RELFFBQUlDLE1BQU0sR0FBRyxJQUFiOztBQUNBLFFBQUlDLFNBQUosRUFBZTtBQUNiRCxNQUFBQSxNQUFNLEdBQUcsb0JBQVQ7QUFDRCxLQUZELE1BRU87QUFDTEEsTUFBQUEsTUFBTSxHQUFHLG9CQUFhRixPQUFiLENBQVQ7QUFDRDs7QUFDRCxXQUFPLElBQUlJLE9BQUos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QUNBO0FBQ0E7QUFFQTtBQUVBRixVQUFBQSxRQUFRLENBQUNvQyx3QkFBRCxDQUFSO0FBQ0FoQyxVQUFBQSxPQUFPLENBQUMsSUFBRCxDQUFQO0FBQ0Q7QUFDRixPQWpCRCxDQWlCRSxPQUFPb0IsS0FBUCxFQUFjO0FBQ2RuQixRQUFBQSxNQUFNLENBQUNtQixLQUFELENBQU47QUFDRDtBQUNGLEtBckJNLENBQVA7QUFzQkQsR0F2QnlCO0FBQUEsQ0FBbkI7OztlQXlCUTtBQUNiM0IsRUFBQUEsUUFBUSxFQUFSQSxRQURhO0FBRWIrQixFQUFBQSxVQUFVLEVBQVZBLFVBRmE7QUFHYk8sRUFBQUEsVUFBVSxFQUFWQTtBQUhhLEMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBnbG9iYWwgaXNCcm93c2VyICovXHJcblxyXG5pbXBvcnQge1xyXG4gIFVTRVJfSU5JVF9MT0FESU5HX0VSUk9SLFxyXG4gIFVTRVJfSU5JVF9MT0FESU5HX1NUQVJULFxyXG4gIFVTRVJfSU5JVF9MT0FESU5HX1NVQ0NFU1MsXHJcbiAgVVNFUl9OT1RfQVVUSE9SSVpFRCxcclxuICBVU0VSX1JFTU9WRSxcclxuICBVU0VSX1VQREFURV9MT0FESU5HX0VSUk9SLFxyXG4gIFVTRVJfVVBEQVRFX0xPQURJTkdfU1RBUlQsXHJcbiAgVVNFUl9VUERBVEVfTE9BRElOR19TVUNDRVNTLFxyXG59IGZyb20gJy4vYWN0aW9uVHlwZXMnO1xyXG5pbXBvcnQgeyBjbGllbnQgYXMgYnJvd3NlckNsaWVudCB9IGZyb20gJy4uLy4uLy4uL2Fwb2xsby9pbmRleC5jbGllbnQnO1xyXG5pbXBvcnQgeyBjbGllbnQgYXMgc2VydmVyQ2xpZW50IH0gZnJvbSAnLi4vLi4vLi4vYXBvbGxvL2luZGV4LnNlcnZlcic7XHJcbmltcG9ydCBDdXJyZW50VXNlckl0ZW1RdWVyeSBmcm9tICcuL0N1cnJlbnRVc2VySXRlbVF1ZXJ5LmdyYXBocWwnO1xyXG5pbXBvcnQgeyByZXNldFVzZXJUb2tlbiB9IGZyb20gJy4vcmVzZXRVc2VyVG9rZW4nO1xyXG5cclxuLyoqXHJcbiAqIEBkZXNjINC80LXRgtC+0LQg0LjQvdC40YbQuNCw0LvQuNC30LDRhtC40Lgg0L/QvtC70YzQt9C+0LLQsNGC0LXQu9GPINCyINGB0LjRgdGC0LXQvNC1XHJcbiAqICovXHJcbmV4cG9ydCBjb25zdCB1c2VySW5pdCA9IChzdGF0ZSwgcmVxdWVzdCkgPT4gZGlzcGF0Y2ggPT4ge1xyXG4gIGxldCBjbGllbnQgPSBudWxsO1xyXG4gIGlmIChpc0Jyb3dzZXIpIHtcclxuICAgIGNsaWVudCA9IGJyb3dzZXJDbGllbnQoKTtcclxuICB9IGVsc2Uge1xyXG4gICAgY2xpZW50ID0gc2VydmVyQ2xpZW50KHJlcXVlc3QpO1xyXG4gIH1cclxuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgaWYgKCFzdGF0ZS51c2VyLmluaXRMb2FkaW5nICYmICFzdGF0ZS51c2VyLmlzQXV0aCkge1xyXG4gICAgICAgIGRpc3BhdGNoKHtcclxuICAgICAgICAgIHR5cGU6IFVTRVJfSU5JVF9MT0FESU5HX1NUQVJULFxyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIGNsaWVudFxyXG4gICAgICAgICAgLnF1ZXJ5KHsgcXVlcnk6IEN1cnJlbnRVc2VySXRlbVF1ZXJ5IH0pXHJcbiAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdyZXNwb25zZTonLCByZXNwb25zZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IHsgZGF0YSB9ID0gcmVzcG9uc2U7XHJcbiAgICAgICAgICAgIGlmIChpc0Jyb3dzZXIpIHtcclxuICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgndXNlcicsIEpTT04uc3RyaW5naWZ5KGRhdGEuY3VycmVudHVzZXJpdGVtKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgZGlzcGF0Y2goeyB0eXBlOiBVU0VSX0lOSVRfTE9BRElOR19TVUNDRVNTLCB1c2VyOiB7IC4uLmRhdGEuY3VycmVudHVzZXJpdGVtIH0gfSk7XHJcbiAgICAgICAgICAgIHJlc29sdmUoZGF0YS5jdXJyZW50dXNlcml0ZW0pO1xyXG4gICAgICAgICAgfSlcclxuICAgICAgICAgIC5jYXRjaChlcnJvciA9PiB7XHJcbiAgICAgICAgICAgIGlmIChpc0Jyb3dzZXIpIHtcclxuICAgICAgICAgICAgICBsb2NhbFN0b3JhZ2UuY2xlYXIoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciB1c2VySW5pdDogJywgZXJyb3IpO1xyXG4gICAgICAgICAgICAvKiogKi9cclxuICAgICAgICAgICAgZGlzcGF0Y2goe1xyXG4gICAgICAgICAgICAgIHR5cGU6IFVTRVJfSU5JVF9MT0FESU5HX0VSUk9SLFxyXG4gICAgICAgICAgICAgIHVzZXI6IHtcclxuICAgICAgICAgICAgICAgIGVycm9yOiBVU0VSX05PVF9BVVRIT1JJWkVELFxyXG4gICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXNvbHZlKGVycm9yKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHJlc29sdmUodHJ1ZSk7XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIHVzZXJJbml0OiAnLCBlcnJvcik7XHJcbiAgICAgIGRpc3BhdGNoKHtcclxuICAgICAgICB0eXBlOiBVU0VSX0lOSVRfTE9BRElOR19FUlJPUixcclxuICAgICAgICB1c2VyOiB7XHJcbiAgICAgICAgICBlcnJvcjogVVNFUl9OT1RfQVVUSE9SSVpFRCxcclxuICAgICAgICB9LFxyXG4gICAgICB9KTtcclxuICAgICAgcmVzb2x2ZShlcnJvcik7XHJcbiAgICB9XHJcbiAgfSk7XHJcbn07XHJcblxyXG5leHBvcnQgY29uc3QgdXNlclVwZGF0ZSA9ICgpID0+IGRpc3BhdGNoID0+IHtcclxuICBsZXQgY2xpZW50ID0gbnVsbDtcclxuICBpZiAoaXNCcm93c2VyKSB7XHJcbiAgICBjbGllbnQgPSBicm93c2VyQ2xpZW50O1xyXG4gIH0gZWxzZSB7XHJcbiAgICBjbGllbnQgPSBzZXJ2ZXJDbGllbnQ7XHJcbiAgfVxyXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICBkaXNwYXRjaCh7XHJcbiAgICAgICAgdHlwZTogVVNFUl9VUERBVEVfTE9BRElOR19TVEFSVCxcclxuICAgICAgICB1c2VyOiB7XHJcbiAgICAgICAgICBsb2FkaW5nOiB0cnVlLFxyXG4gICAgICAgIH0sXHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgY2xpZW50KClcclxuICAgICAgICAucXVlcnkoeyBxdWVyeTogQ3VycmVudFVzZXJJdGVtUXVlcnkgfSlcclxuICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XHJcbiAgICAgICAgICBjb25zdCB7IGRhdGEgfSA9IHJlc3BvbnNlO1xyXG4gICAgICAgICAgaWYgKGlzQnJvd3Nlcikge1xyXG4gICAgICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgndXNlcicsIEpTT04uc3RyaW5naWZ5KGRhdGEuY3VycmVudHVzZXJpdGVtKSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBkaXNwYXRjaCh7IHR5cGU6IFVTRVJfVVBEQVRFX0xPQURJTkdfU1VDQ0VTUywgdXNlcjogeyAuLi5kYXRhLmN1cnJlbnR1c2VyaXRlbSB9IH0pO1xyXG4gICAgICAgICAgcmVzb2x2ZShkYXRhLmN1cnJlbnR1c2VyaXRlbSk7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goZXJyb3IgPT4ge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coZXJyb3IpO1xyXG4gICAgICAgICAgaWYgKGlzQnJvd3Nlcikge1xyXG4gICAgICAgICAgICBsb2NhbFN0b3JhZ2UuY2xlYXIoKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGRpc3BhdGNoKHsgdHlwZTogVVNFUl9VUERBVEVfTE9BRElOR19FUlJPUiwgdXNlcjogeyBlcnJvcjogZXJyb3IgfSB9KTtcclxuICAgICAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICByZWplY3QoZXJyb3IpO1xyXG4gICAgfVxyXG4gIH0pO1xyXG59O1xyXG5cclxuZXhwb3J0IGNvbnN0IHVzZXJSZW1vdmUgPSAoKSA9PiBkaXNwYXRjaCA9PiB7XHJcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIGlmIChpc0Jyb3dzZXIpIHtcclxuICAgICAgICAvLyB3aW5kb3cubG9jYWxTdG9yYWdlLmNsZWFyKCk7XHJcbiAgICAgICAgLy8gY29uc3QgY29va2llcyA9IGRvY3VtZW50LmNvb2tpZS5zcGxpdCgnOycpO1xyXG5cclxuICAgICAgICAvLyBmb3IgKGxldCBpID0gMDsgaSA8IGNvb2tpZXMubGVuZ3RoOyBpICs9IDEpIHtcclxuICAgICAgICAvLyAgIGNvbnN0IGNvb2tpZSA9IGNvb2tpZXNbaV07XHJcbiAgICAgICAgLy8gICBjb25zdCBlcVBvcyA9IGNvb2tpZS5pbmRleE9mKCc9Jyk7XHJcbiAgICAgICAgLy8gICBjb25zdCBuYW1lID0gZXFQb3MgPiAtMSA/IGNvb2tpZS5zdWJzdHIoMCwgZXFQb3MpIDogY29va2llO1xyXG4gICAgICAgIC8vICAgZG9jdW1lbnQuY29va2llID0gYCR7bmFtZX09O2V4cGlyZXM9VGh1LCAwMSBKYW4gMTk3MCAwMDowMDowMCBHTVRgO1xyXG4gICAgICAgIC8vIH1cclxuXHJcbiAgICAgICAgcmVzZXRVc2VyVG9rZW4oKTtcclxuXHJcbiAgICAgICAgZGlzcGF0Y2goVVNFUl9SRU1PVkUpO1xyXG4gICAgICAgIHJlc29sdmUodHJ1ZSk7XHJcbiAgICAgIH1cclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgIHJlamVjdChlcnJvcik7XHJcbiAgICB9XHJcbiAgfSk7XHJcbn07XHJcblxyXG5leHBvcnQgZGVmYXVsdCB7XHJcbiAgdXNlckluaXQsXHJcbiAgdXNlclVwZGF0ZSxcclxuICB1c2VyUmVtb3ZlLFxyXG59O1xyXG4iXX0=